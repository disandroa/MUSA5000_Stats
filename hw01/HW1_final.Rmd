---
title: "Predicting Median House Value in Philadelphia"
author: "Akira Di Sandro, Sofia Fasullo, Amy Solano"
date: "2024-10-14"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, eval = T, warning = F, message = F)

# get rid of scientific notation
options(scipen = 999)

# load appropriate packages
library(tidyverse)
library(sf)
library(FNN)
library(grid)
library(gridExtra)
library(kableExtra)
library(ggcorrplot)
library(rmarkdown)
library(pander)
library(Hmisc)
library(car)
library(DAAG)
library(MASS)
```

# Introduction

**intro paragraphs**

```{r load_data, echo=F, include=F}
regdata <- read.csv("RegressionData.csv")
regshp <- st_read("Lecture 1 - RegressionData.shp/RegressionData.shp")

```

# Methods

## Data Cleaning


## Exploratory Data Analysis

[describe variables]

[formula for sample correlation coefficient]

## Multiple Regression Analysis

[specific regression equation for this problem]

[state hypothesis being tested]

## Additional Analyses

[stepwise regression]

[k-fold cross-validation]

## Software


# Results

## Exploratory Results

### Summary Statistics of Variables

[describe summary stats]

```{r sum_stats}
sumstats <- regdata %>% 
  summarise(
    mean_MEDHVAL = mean(MEDHVAL),
    sd_MEDHVAL = sd(MEDHVAL),
    mean_PCTBACHMOR = mean(PCTBACHMOR),
    sd_PCTBACHMOR = sd(PCTBACHMOR),
    mean_MEDHHINC = mean(MEDHHINC),
    sd_MEDHHINC = sd(MEDHHINC),
    mean_PCTVACANT = mean(PCTVACANT),
    sd_PCTVACANT = sd(PCTVACANT),
    mean_PCTSINGLES = mean(PCTSINGLES),
    sd_PCTSINGLES = sd(PCTSINGLES),
    mean_NBELPOV100 = mean(NBELPOV100),
    sd_NBELPOV100 = sd(NBELPOV100),
    )
    
means <- sumstats %>% 
  pivot_longer(cols = all_of(starts_with("mean_")),
               names_to = "variable",
               values_to = "Mean",
               names_prefix = "mean_") %>% 
  dplyr::select(variable:Mean)


sds <- sumstats %>% 
  pivot_longer(cols = all_of(starts_with("sd_")),
               names_to = "variable",
               values_to = "SD",
               names_prefix = "sd_") %>% 
  dplyr::select(variable:SD)

# create a clean dataframe for table
sumstats_tab <- left_join(means, sds, by = "variable") %>% 
  rename(rowname = 1) %>% 
  column_to_rownames() %>% 
  t() %>% 
  data.frame() %>% 
  mutate(`Median House Value (MEDHVAL)` = paste0("$",format(round(MEDHVAL, 2), big.mark = ",", nsmall = 2)),
         `Pct Bachelor or more (PCTBACHMOR)` = paste0(format(round(PCTBACHMOR, 1), nsmall = 1), "%"),
         `Median Household Income (MEDHHINC)` = paste0("$",format(round(MEDHHINC, 2), big.mark = ",", nsmall = 2)),
         `Pct Vacant (PCTVACANT)` = paste0(format(round(PCTVACANT, 1), nsmall = 1), "%"),
         `Pct Single Unit (PCTSINGLES)` = paste0(format(round(PCTSINGLES, 1), nsmall = 1), "%"),
         `Units Below Poverty level (NBELPOV100)` = format(round(NBELPOV100), nsmall = 0),
         .keep = "unused") %>% 
  t() %>% 
  data.frame() %>% 
  rownames_to_column(var = "Variable")
 
sumstats_tab %>% 
  kbl(caption = "Table 1. Summary Statistics of Dependent and Independent Variables",
      align = "lcc") %>% 
  kable_styling() %>%
  kable_classic(full_width = F, html_font = "Cambria") 

```

### Variable Histograms

[normality of variables]

```{r histograms_setup}
# MEDHVAL
hist_medhval <- ggplot(regdata) +
  geom_histogram(aes(x = MEDHVAL), fill = "#451077FF") +
  theme_minimal() +
  labs(x = "Median House Value",
       y = "Count") +
  scale_x_continuous(labels = scales::dollar)

# PCTBACHMOR
hist_pctbach <- regdata %>% 
  mutate(PCTBACHMOR = PCTBACHMOR / 100) %>% 
  ggplot() +
  geom_histogram(aes(x = PCTBACHMOR), fill = "#451077FF") +
  theme_minimal() +
  labs(x = "% residents with at least\na Bachelor's Degree",
       y = "Count") +
  scale_x_continuous(labels = scales::percent)

# MEDHHINC
hist_medhhinc <- ggplot(regdata) +
  geom_histogram(aes(x = MEDHHINC), fill = "#451077FF") +
  theme_minimal() +
  labs(x = "Median Household Income",
       y = "Count") +
  scale_x_continuous(labels = scales::dollar)

# PCTVACANT
hist_pctvac <- regdata %>% 
  mutate(PCTVACANT = PCTVACANT / 100) %>% 
  ggplot() +
  geom_histogram(aes(x = PCTVACANT), fill = "#451077FF") +
  theme_minimal() +
  labs(x = "% housing units that are vacant",
       y = "Count") +
  scale_x_continuous(labels = scales::percent)

# PCTSINGLES
hist_pctsing <- regdata %>% 
  mutate(PCTSINGLES = PCTSINGLES / 100) %>% 
  ggplot() +
  geom_histogram(aes(x = PCTSINGLES), fill = "#451077FF") +
  theme_minimal() +
  labs(x = "% housing units that are detached\nsingle family houses",
       y = "Count") +
  scale_x_continuous(labels = scales::percent)

# NBELPOV100
hist_nbelpov <- ggplot(regdata) +
  geom_histogram(aes(x = NBELPOV100), fill = "#451077FF") +
  theme_minimal() +
  labs(x = "# of households living in poverty",
       y = "Count")

# log-transformed variables
regdata_log <- regdata %>% 
  mutate(LNMEDHVAL = log(MEDHVAL),
         LNPCBACHMORE = log(1 + PCTBACHMOR),
         LNNBELPOV100 = log(1 + NBELPOV100),
         LNPCTVACANT = log(1 + PCTVACANT),
         LNPCTSINGLES = log(1 + PCTSINGLES),
         LNMEDHHINC = log(MEDHHINC))

# LNMEDHVAL
hist_lnmedhval <- ggplot(regdata_log) +
  geom_histogram(aes(x = LNMEDHVAL), fill = "#451077FF") +
  theme_minimal() +
  labs(x = "Log-transformed Median House Value",
       y = "Count")

# log PCTBACHMOR
hist_lnpctbach <- regdata_log %>% 
  ggplot() +
  geom_histogram(aes(x = LNPCBACHMORE), fill = "#451077FF") +
  theme_minimal() +
  labs(x = "Log-transformed % residents with at\nleast a Bachelor's Degree",
       y = "Count")
      
# log MEDHHINC
hist_lnmedhhinc <- ggplot(regdata_log) +
  geom_histogram(aes(x = LNMEDHHINC), fill = "#451077FF") +
  theme_minimal() +
  labs(x = "Log-transformed Median Household Income",
       y = "Count")

# log PCTVACANT
hist_lnpctvac <- regdata_log %>% 
  ggplot() +
  geom_histogram(aes(x = LNPCTVACANT), fill = "#451077FF") +
  theme_minimal() +
  labs(x = "Log-transformed % housing units that are vacant",
       y = "Count")
      
# log PCTSINGLES
hist_lnpctsing <- regdata_log %>% 
  ggplot() +
  geom_histogram(aes(x = LNPCTSINGLES), fill = "#451077FF") +
  theme_minimal() +
  labs(x = "Log-transformed % housing units that are\ndetached single family houses",
       y = "Count")
      
# log NBELPOV100
hist_lnnbelpov <- ggplot(regdata_log) +
  geom_histogram(aes(x = LNNBELPOV100), fill = "#451077FF") +
  theme_minimal() +
  labs(x = "Log-transformed # of households\nliving in poverty",
       y = "Count")


```


```{r medhval_hist}
# histogram of raw and log-transformed medhval
grid.arrange(hist_medhval, hist_lnmedhval,
             ncol = 2,
             top = textGrob("Distribution of MEDHVAL: Median House Value\n(raw and log-transformed)", 
                            gp = gpar(fontsize = 16, fontface = "bold")))
    

```


```{r pcbach_hist}
# histogram of raw and log-transformed medhval
grid.arrange(hist_pctbach, hist_lnpctbach,
             ncol = 2,
             top = textGrob("Distribution of PCTBACH: Proportion of residents with\nat least a Bachelor's Degree (raw and log-transformed)", 
                            gp = gpar(fontsize = 16, fontface = "bold")))
    

```


```{r nbelpov_hist}
# histogram of raw and log-transformed nbelpov100
grid.arrange(hist_nbelpov, hist_lnnbelpov,
             ncol = 2,
             top = textGrob("Distribution of NBELPOV100: Number of households living\nin poverty (raw and log-transformed)",
                            gp = gpar(fontsize = 16, fontface = "bold")))
    

```


```{r pctvac_hist}
# histogram of raw and log-transformed pctvacant
grid.arrange(hist_pctvac, hist_lnpctvac,
             ncol = 2,
             top = textGrob("Distribution of PCTVACANT: Proportion of housing units\nthat are vacant (raw and log-transformed)",
                            gp = gpar(fontsize = 16, fontface = "bold")))
    

```


```{r pctsing_hist}
# histogram of raw and log-transformed PCTSINGLES
grid.arrange(hist_pctsing, hist_lnpctsing,
             ncol = 2,
             top = textGrob("Distribution of PCTSINGLES: Percent of housing units that are\ndetached single family houses (raw and log-transformed)",
                            gp = gpar(fontsize = 16, fontface = "bold")))
    

```


### Chloropleth Maps

```{r chloropleth_setup}
chloro_lnmedhval <- regshp %>%
  ggplot() +
  geom_sf(aes(fill = LNMEDHVAL)) +
  theme_void() +
  scale_fill_viridis_c(option = "magma",
                       name = "Log Med. House Val.",
                       na.value = "grey") +
  labs(title = "Median House Values (log-transformed) in Philadelphia")

# PCTVACANT
chloro_pctvac <- regshp %>% 
  ggplot() +
  geom_sf(aes(fill = PCTVACANT), color = "transparent") +
  theme_void() +
  scale_fill_viridis_c(option = "magma",
                       name = "Pct Vacant",
                       na.value = "grey",
                       limits = c(0, 100)) +
  labs(title = "Percent housing units\nthat are vacant")

# PCTSINGLES
chloro_pctsing <- regshp %>% 
  ggplot() +
  geom_sf(aes(fill = PCTSINGLES), color = "transparent") +
  theme_void() +
  scale_fill_viridis_c(option = "magma",
                       name = "Pct Single Unit",
                       na.value = "grey",
                       limits = c(0, 100)) +
  labs(title = "Percent housing units that are\ndetached single family houses")

# PCTBACHMOR
chloro_pctbach <- regshp %>% 
  ggplot() +
  geom_sf(aes(fill = PCTBACHMOR), color = "transparent") +
  theme_void() +
  scale_fill_viridis_c(option = "magma",
                       name = "Pct Bach.",
                       na.value = "grey",
                       limits = c(0, 100)) +
  labs(title = "Percent of residents with at\nleast a Bachelor's Degree")

# LNNBELPOV
chloro_lnnbelpov <- regshp %>% 
  ggplot() +
  geom_sf(aes(fill = LNNBELPOV), color = "transparent") +
  theme_void() +
  scale_fill_viridis_c(option = "magma",
                       name = "Log Units",
                       na.value = "grey",
                       limits = c(0, 8)) +
  labs(title = "Number of households living\nin poverty (log-transformed)")

```


```{r medhval_chloro}
chloro_lnmedhval
```


```{r predictors_chloro, fig.height=8}
# display all four figures in one
grid.arrange(chloro_pctbach, chloro_pctvac, chloro_pctsing, chloro_lnnbelpov,
             ncol = 2,
             top = textGrob("Chloropleth Maps of Predictors", 
                            gp = gpar(fontsize = 16, fontface = "bold")))
```


### Correlation Matrix

```{r cormat}
cormat <- regdata_log %>% 
  dplyr::select(PCTVACANT,PCTSINGLES,PCTBACHMOR,LNNBELPOV100) %>% 
  cor()

cor_plot <- ggcorrplot(cormat,
                       method = "circle",
                       type = "lower",
                       lab = TRUE,
                       lab_size = 3,
                       colors = c("#451077FF", "white", "#F1605DFF"),
                       outline.color = "white",
                       title = "Correlation Matrix of Predictors",
                       legend.title = "Correlation") +
  theme_minimal() +  
  labs(x = "",
       y = "") +
  theme(axis.text.x = element_text(angle = 20))

cor_plot

```



## Regression Results

### Regression Output

```{r reg1}
reg1 <- lm(LNMEDHVAL ~ PCTVACANT + PCTSINGLES + PCTBACHMOR + LNNBELPOV100, regdata_log)

reg1_sum <- summary(reg1)
reg1_anova <- anova(reg1)

reg1_res <- regdata_log %>% 
  mutate(predicted_LNMEDHVAL = fitted(reg1),
         predicted_MEDHVAL = exp(predicted_LNMEDHVAL),
         residual = resid(reg1),
         std_residual = rstandard(reg1))

reg1_sum
```


### Regression Assumptions Check

[testing model assumptions -- we looked at variable distributions earlier]

### Scatter Plots

```{r scatter_setup}
scatter_pctbach <- regdata_log %>% 
  ggplot() +
  geom_point(aes(x = PCTBACHMOR, y = LNMEDHVAL), color = "#451077FF") +
  theme_minimal() +
  labs(x = "Proportion of residents with at\nleast a Bachelor's Degree",
       y = "Median House Value (Log-transformed)") 

scatter_pctvac <- regdata_log %>% 
  ggplot() +
  geom_point(aes(x = PCTVACANT, y = LNMEDHVAL), color = "#451077FF") +
  theme_minimal() +
  labs(x = "Proportion of housing units that are vacant",
       y = "Median House Value (Log-transformed)") 

scatter_pctsing <- regdata_log %>% 
  ggplot() +
  geom_point(aes(x = PCTSINGLES, y = LNMEDHVAL), color = "#451077FF") +
  theme_minimal() +
  labs(x = "Percent of housing units that are\ndetached single family houses",
       y = "Median House Value (Log-transformed)") 

scatter_lnnbelpov <- regdata_log %>% 
  ggplot() +
  geom_point(aes(x = LNNBELPOV100, y = LNMEDHVAL), color = "#451077FF") +
  theme_minimal() +
  labs(x = "Number of households living\nin poverty (log-transformed)",
       y = "Median House Value (Log-transformed)") 
```


```{r predictor_scatter, fig.height=8}
# display all four figures in one
grid.arrange(scatter_pctbach, scatter_pctvac, scatter_pctsing, scatter_lnnbelpov,
             ncol = 2,
             top = textGrob("Median House Value (log-transformed) as\na function of the Predictors", 
                            gp = gpar(fontsize = 16, fontface = "bold")))

```


### Standardized Residuals

```{r std_resid_hist}
hist_std_resid <- ggplot(reg1_res) +
  geom_histogram(aes(x = std_residual), fill = "#451077FF") +
  theme_minimal() +
  labs(title = "Distribution of Standardized Regression Residual",
       x = "Standardized Regression Residual",
       y = "Count")

hist_std_resid

```


```{r std_resid_scatter}
scatter_std_resid <- reg1_res %>% 
  ggplot() +
  geom_hline(yintercept = 0, color = "#F1605DFF") +
  geom_point(aes(x = predicted_LNMEDHVAL, y = std_residual), color = "#451077FF") +
  theme_minimal() +
  labs(title = "Standardized Residuals of Regression Model as a response of Predicted Values",
       x = "Predicted Median House Value (log-transformed)",
       y = "Standardized Residual")

scatter_std_resid

```

[discuss spatial autocorrelation of vars using chloropleths from before]


```{r std_resid_chloro}
chloro_std_resid <- left_join(regshp,
                              reg1_res %>% 
                                dplyr::select(POLY_ID,LNNBELPOV100,predicted_LNMEDHVAL:std_residual),
                              by = "POLY_ID") %>% 
  ggplot() +
  geom_sf(aes(fill = std_residual)) +
  theme_void() +
  scale_fill_gradient2(name = "Stand. Res.",
                       low = "#451077FF",
                       mid = "white",
                       high = "#F1605DFF",
                       na.value = "grey",
                       limits = c(-6.25, 6.25)) +
  labs(title = "Standardized Regression Residual",
       fill = "Stand. Res.")

left_join(regshp,
          reg1_res %>% 
            dplyr::select(POLY_ID,LNNBELPOV100,predicted_LNMEDHVAL:std_residual),
          by = "POLY_ID") %>% 
  ggplot() +
  geom_sf(aes(fill = std_residual)) +
  theme_void() +
  scale_fill_viridis_c(option = "magma",
                       name = "Stand. Res.",
                       na.value = "grey",
                       limits = c(-6.25, 6.25)) +
  labs(title = "Standardized Regression Residual",
       fill = "Stand. Res.")


chloro_std_resid
    
```

[discuss spatial patterns of stand. resids]

### Stepwise Regression

```{r step_reg}
step_reg <- stepAIC(reg1, direction="both")

step_reg$anova
```


### Cross-validation

```{r cv_results}
cv_reg1 <- CVlm(data = regdata_log,
                form.lm = reg1,
                m = 5, 
                seed = 217,
                printit = F,
                plotit = F)

mse1 <- attr(cv_reg1, "ms")
rmse1 <- sqrt(mse1)	

reg2 <- lm(LNMEDHVAL ~ PCTVACANT + MEDHHINC, regdata_log)

cv_reg2 <- CVlm(data = regdata_log, 
                form.lm = reg2, 
                m = 5, 
                seed = 217,
                printit = F,
                plotit = F)

mse2 <- attr(cv_reg2, "ms")
rmse2 <- sqrt(mse2)

# table comparing RMSE
rmse_table <- data.frame(round(rmse1, 5),
                         round(rmse2, 5))
row.names(rmse_table) <- "Root Mean Squared Error (RMSE)"

rmse_table %>% 
  kbl(caption = "Table 2. Comparing RMSE of Original and Simplified Models",
      align = "c",
      col.names = c("Original Model", "Simplified Model")) %>% 
  kable_styling() %>% 
  kable_classic(full_width = F, html_font = "Cambria") %>% 
  add_footnote(label = "\"Original Model\" refers to the model that uses all four predictors (PCTVACANT, PCTSINGLES, PCTBACHMOR, and LNNBELPOV100) to predict LNMEDHVAL, while \"Simplified Model\" refers to the model with only two predictors: PCTVACANT and MEDHHINCOME.",
               notation = "none")

```


# Discussion and Limitations

## Conclusions


## Limitations of Model



## Ridge or Lasso?

